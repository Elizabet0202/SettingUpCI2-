# AppVeyor: Windows + JDK 8, запуск SUT и тесты
image: Visual Studio 2022

environment:
  matrix:
    - JDK_VERSION: 8

install:
  - where java
  - java -version
  - gradlew.bat --version

build_script:
  # 1) Сборка артефакта без тестов (чтобы не гонять тесты дважды)
  - gradlew.bat clean assemble --info

  # 2) Копируем jar туда, где его ждут по заданию
  - if not exist src\artifacts mkdir src\artifacts
  - copy build\libs\*.jar src\artifacts\app-mbank.jar

  # 3) Пауэршелл: запускаем SUT в фоне и сохраняем PID
  - ps: |
      $jar = Join-Path $env:APPVEYOR_BUILD_FOLDER "src\artifacts\app-mbank.jar"
      if (-not (Test-Path $jar)) { Write-Host "ERROR: jar not found at $jar"; exit 1 }
      Write-Host "Starting SUT: $jar"
      # ВАЖНО: используем свою переменную, НЕ $pid / $PID
      $proc = Start-Process -FilePath "java" -ArgumentList @("-jar", $jar) -NoNewWindow -PassThru
      $serverPid = $proc.Id
      "PID=$serverPid" | Set-Content -Path "server_pid.txt" -Encoding ASCII
      Write-Host "SUT started, PID = $serverPid"

  # 4) Ждём готовность порта 9999 (максимум 45 секунд)
  - ps: |
      $port = 9999
      $maxWait = 45
      Write-Host "Waiting for SUT on http://localhost:$port (timeout ${maxWait}s)..."
      for ($i=0; $i -lt $maxWait; $i++) {
        $ok = (Test-NetConnection -ComputerName 'localhost' -Port $port -WarningAction SilentlyContinue).TcpTestSucceeded
        if ($ok) { Write-Host "SUT is up on port $port"; break }
        Start-Sleep -Seconds 1
      }
      if ($i -ge $maxWait) {
        Write-Host "ERROR: SUT did not start within ${maxWait}s"
        if (Test-Path "server_pid.txt") { Get-Content server_pid.txt | Write-Host }
        exit 1
      }

  # 5) Запускаем тесты (теперь SUT точно слушает порт)
  - gradlew.bat test --info

  # 6) Останавливаем SUT по PID
  - ps: |
      if (Test-Path "server_pid.txt") {
        $line = Get-Content server_pid.txt
        if ($line -match "PID=(\d+)") {
          $serverPid = [int]$Matches[1]
          Write-Host "Stopping SUT pid $serverPid"
          Stop-Process -Id $serverPid -Force -ErrorAction SilentlyContinue
        }
        Remove-Item server_pid.txt -ErrorAction SilentlyContinue
      } else {
        Write-Host "No server_pid.txt found — nothing to stop"
      }

# публикуем JAR как артефакт сборки (удобно для проверки)
artifacts:
  - path: src\artifacts\app-mbank.jar
    name: app-mbank

branches:
  only:
    - main