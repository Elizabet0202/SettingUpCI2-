image: Visual Studio 2022

# 1) Ставим JDK 11 и переключаемся на него (без догадок по путям)
install:
  - choco install temurin11 -y
  - refreshenv
  - for /d %%D in ("C:\Program Files\Eclipse Adoptium\jdk-11.*") do set "JAVA_HOME=%%D"
  - set PATH=%JAVA_HOME%\bin;%PATH%
  - where java
  - java -version
  - gradlew.bat --version

# 2) Сборка, выкладка jar в artifacts/, запуск SUT и ожидание порта 9999
build_script:
  - gradlew.bat clean assemble --info

  # ВАЖНО: по условию задания jar должен лежать в ./artifacts (в корне репо, не в src/)
  - if not exist artifacts mkdir artifacts
  - copy build\libs\*.jar artifacts\app-mbank.jar

  # Запускаем SUT в фоне и сохраняем PID
  - ps: |
      $jar = Join-Path $env:APPVEYOR_BUILD_FOLDER "artifacts\app-mbank.jar"
      if (-not (Test-Path $jar)) { Write-Host "ERROR: jar not found at $jar"; exit 1 }
      $p = Start-Process -FilePath "java" -ArgumentList "-jar", ""$jar"" -PassThru -NoNewWindow
      $p.Id | Set-Content -Path "server_pid.txt" -Encoding ascii
      Write-Host "SUT PID: $($p.Id)"

  # Ждём доступности порта 9999 (макс. 60с)
  - ps: |
      $port=9999; $max=60
      Write-Host "Waiting for http://localhost:$port (timeout ${max}s)..."
      for ($i=0; $i -lt $max; $i++) {
        if ((Test-NetConnection -ComputerName localhost -Port $port -WarningAction SilentlyContinue).TcpTestSucceeded) {
          Write-Host "SUT is UP on $port"; break
        }
        Start-Sleep -Seconds 1
      }
      if ($i -ge $max) { Write-Error "SUT did not start in time"; exit 1 }

  # Прогон тестов
  - gradlew.bat test --info

  # Корректно останавливаем SUT
  - ps: |
      if (Test-Path server_pid.txt) {
        $pid = Get-Content server_pid.txt | Select-Object -First 1
        Write-Host "Stopping SUT pid $pid"
        Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue
      }

# Публикуем артефакт
artifacts:
  - path: artifacts\app-mbank.jar
    name: app-mbank

branches:
  only:
    - main